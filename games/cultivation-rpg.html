<!--
Game: Cultivation RPG (single-file)
Loop: Meditate to gain Qi -> Train skills -> Explore for resources/events -> Attempt breakthroughs to advance realms -> Fight enemies when encountered.
Realms: Mortal -> Qi Condensation (1-9) -> Foundation Establishment (1-3) [demo caps here]
Resources: Qi (for breakthroughs/skills), Spirit Stones (currency), Pills (boost breakthrough), HP (health).
Skills: Meridian Flow (Qi gain), Fist Technique (damage), Body Tempering (HP), Footwork (evasion).
Breakthroughs: Require Qi >= threshold; success chance increases with Pill use and skill; failure drains Qi and HP.
Combat: Simple turn-based vs. a generated enemy; actions: Attack, Defend, Skill, Pill, Flee.
Accessibility: Keyboard support for tabs/actions, aria-live status updates. Single-file (inline CSS+JS, no external assets).
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cultivation RPG</title>
  <style>
    :root{--bg:#0b1220;--panel:#111a2e;--panel2:#16213f;--text:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee;--accent2:#7c3aed;--warn:#f59e0b;--danger:#ef4444;--ok:#10b981}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 40% -10%,#1a2750,#0b1220 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
  h1{margin:0 0 12px;font-size:22px;background:linear-gradient(90deg,var(--accent),var(--accent2));background-clip:text;-webkit-background-clip:text;color:transparent}
    .hud{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .chip{background:linear-gradient(180deg,#16213f,#101833);border:1px solid #233258;border-radius:999px;padding:6px 10px;font-size:13px}
    .bars{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px}
    .bar{background:#0d1427;border:1px solid #233258;border-radius:8px;overflow:hidden;height:16px;position:relative}
    .fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0}
    .bar .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#d1d5db}
    .tabs{display:flex;gap:8px;margin:8px 0 12px}
    .tabs button{background:#0f1830;border:1px solid #233258;color:#e5e7eb;padding:8px 12px;border-radius:8px;cursor:pointer}
    .tabs button.active{outline:2px solid var(--accent);}
    .panel{background:linear-gradient(180deg,#0f1830,#0b1428);border:1px solid #233258;border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .btn{background:linear-gradient(180deg,#1a2d55,#142448);border:1px solid #284070;color:#e5e7eb;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.warn{background:#3a2a09;border-color:#8a620a}
    .btn.danger{background:#3a1212;border-color:#7a1d1d}
    .list{display:grid;gap:8px}
    .list .item{display:flex;justify-content:space-between;align-items:center;background:#0d152a;border:1px solid #223257;border-radius:10px;padding:8px}
    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .combat{display:none}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Cultivation RPG">
    <h1>Cultivation RPG</h1>

    <div class="hud" id="hud">
      <div class="chip" id="realmChip">Realm: Mortal</div>
      <div class="chip" id="qiChip">Qi: 0 / 100</div>
      <div class="chip" id="hpChip">HP: 100 / 100</div>
      <div class="chip" id="stonesChip">Stones: 0</div>
      <div class="chip" id="pillsChip">Pills: 0</div>
      <div class="chip" id="powerChip">Power: 1</div>
    </div>

    <div class="bars">
      <div class="bar" aria-label="Qi progress"><div class="fill" id="qiFill"></div><div class="label" id="qiLabel">Qi 0%</div></div>
      <div class="bar" aria-label="HP progress"><div class="fill" id="hpFill" style="background:linear-gradient(90deg,#ef4444,#f59e0b)"></div><div class="label" id="hpLabel">HP 100%</div></div>
    </div>

    <div class="tabs" role="tablist">
      <button class="active" role="tab" id="tab-cultivate">Cultivate</button>
      <button role="tab" id="tab-train">Train</button>
      <button role="tab" id="tab-explore">Explore</button>
      <button role="tab" id="tab-inventory">Inventory</button>
    </div>

    <div class="panel" id="panel-cultivate" role="tabpanel">
      <div class="row">
        <button class="btn" id="meditateBtn">Meditate (+Qi)</button>
        <button class="btn" id="breakthroughBtn">Attempt Breakthrough</button>
        <button class="btn warn" id="usePillBtn">Consume Pill (+success)</button>
      </div>
      <div class="small">Breakthrough requires sufficient Qi. Pills increase success chance. Failure drains Qi and HP.</div>
      <div class="status" id="statusCultivate" aria-live="polite"></div>
    </div>

    <div class="panel" id="panel-train" role="tabpanel" hidden>
      <div class="list">
        <div class="item"><div>
          <div><strong>Meridian Flow</strong> — Boosts Qi gain</div>
          <div class="small">Level <span id="lvMeridian">1</span></div>
        </div><button class="btn" id="trainMeridian">Train (5 Stones)</button></div>

        <div class="item"><div>
          <div><strong>Fist Technique</strong> — Increases damage</div>
          <div class="small">Level <span id="lvFist">1</span></div>
        </div><button class="btn" id="trainFist">Train (5 Stones)</button></div>

        <div class="item"><div>
          <div><strong>Body Tempering</strong> — Increases max HP</div>
          <div class="small">Level <span id="lvBody">1</span></div>
        </div><button class="btn" id="trainBody">Train (5 Stones)</button></div>

        <div class="item"><div>
          <div><strong>Footwork</strong> — Increases evasion</div>
          <div class="small">Level <span id="lvFoot">1</span></div>
        </div><button class="btn" id="trainFoot">Train (5 Stones)</button></div>
      </div>
    </div>

    <div class="panel" id="panel-explore" role="tabpanel" hidden>
      <div class="row">
        <button class="btn" id="exploreBtn">Explore</button>
      </div>
      <div class="status" id="statusExplore" aria-live="polite"></div>
    </div>

    <div class="panel" id="panel-inventory" role="tabpanel" hidden>
      <div class="list">
        <div class="item"><span>Spirit Stones</span><span id="invStones">0</span></div>
        <div class="item"><span>Pills</span><span id="invPills">0</span></div>
      </div>
      <div class="sep"></div>
      <div class="small">Event Log</div>
      <div class="list" id="logList"></div>
    </div>

    <div class="panel combat" id="panel-combat" role="region" aria-label="Combat">
      <div class="grid2">
        <div>
          <div><strong>You</strong> — HP <span id="youHP">0</span>/<span id="youHPMax">0</span> • Power <span id="youPow">0</span></div>
        </div>
        <div>
          <div><strong>Enemy</strong> — HP <span id="enHP">0</span>/<span id="enHPMax">0</span> • Power <span id="enPow">0</span></div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="actAttack">Attack</button>
        <button class="btn" id="actDefend">Defend</button>
        <button class="btn" id="actSkill">Skill</button>
        <button class="btn" id="actFlee">Flee</button>
      </div>
      <div class="status" id="statusCombat" aria-live="polite"></div>
    </div>
  </div>

  <script>
  (function(){
    const els={
      realmChip:document.getElementById('realmChip'), qiChip:document.getElementById('qiChip'), hpChip:document.getElementById('hpChip'),
      stonesChip:document.getElementById('stonesChip'), pillsChip:document.getElementById('pillsChip'), powerChip:document.getElementById('powerChip'),
      qiFill:document.getElementById('qiFill'), hpFill:document.getElementById('hpFill'), qiLabel:document.getElementById('qiLabel'), hpLabel:document.getElementById('hpLabel'),
      tabCultivate:document.getElementById('tab-cultivate'), tabTrain:document.getElementById('tab-train'), tabExplore:document.getElementById('tab-explore'), tabInventory:document.getElementById('tab-inventory'),
      panelCultivate:document.getElementById('panel-cultivate'), panelTrain:document.getElementById('panel-train'), panelExplore:document.getElementById('panel-explore'), panelInventory:document.getElementById('panel-inventory'),
      meditateBtn:document.getElementById('meditateBtn'), breakthroughBtn:document.getElementById('breakthroughBtn'), usePillBtn:document.getElementById('usePillBtn'),
      statusCultivate:document.getElementById('statusCultivate'), statusExplore:document.getElementById('statusExplore'),
      trainMeridian:document.getElementById('trainMeridian'), trainFist:document.getElementById('trainFist'), trainBody:document.getElementById('trainBody'), trainFoot:document.getElementById('trainFoot'),
      lvMeridian:document.getElementById('lvMeridian'), lvFist:document.getElementById('lvFist'), lvBody:document.getElementById('lvBody'), lvFoot:document.getElementById('lvFoot'),
      exploreBtn:document.getElementById('exploreBtn'),
      panelCombat:document.getElementById('panel-combat'), actAttack:document.getElementById('actAttack'), actDefend:document.getElementById('actDefend'), actSkill:document.getElementById('actSkill'), actFlee:document.getElementById('actFlee'),
      statusCombat:document.getElementById('statusCombat'), logList:document.getElementById('logList'),
      youHP:document.getElementById('youHP'), youHPMax:document.getElementById('youHPMax'), youPow:document.getElementById('youPow'),
      enHP:document.getElementById('enHP'), enHPMax:document.getElementById('enHPMax'), enPow:document.getElementById('enPow'),
      invStones:document.getElementById('invStones'), invPills:document.getElementById('invPills'),
    };

    const tiers=['Mortal','Qi Condensation','Foundation Establishment'];
    const state={
      realmTier:0, realmLevel:1,
      qi:0, qiMax:100, hp:100, hpMax:100,
      stones:0, pills:0, power:1,
      skills:{ meridian:1, fist:1, body:1, foot:1 },
      combat:null
    };

    let currentPanelId = 'panel-cultivate';
    function selectTab(btnId, panelId){
      [els.tabCultivate,els.tabTrain,els.tabExplore,els.tabInventory].forEach(b=>b.classList.remove('active'));
      [els.panelCultivate,els.panelTrain,els.panelExplore,els.panelInventory].forEach(p=>p.hidden=true);
      document.getElementById(btnId).classList.add('active');
      document.getElementById(panelId).hidden=false;
      currentPanelId = panelId;
    }
    els.tabCultivate.addEventListener('click',()=>selectTab('tab-cultivate','panel-cultivate'));
    els.tabTrain.addEventListener('click',()=>selectTab('tab-train','panel-train'));
    els.tabExplore.addEventListener('click',()=>selectTab('tab-explore','panel-explore'));
    els.tabInventory.addEventListener('click',()=>selectTab('tab-inventory','panel-inventory'));

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function recalc(){ state.power = state.skills.fist*2 + Math.floor(state.realmLevel/2) + state.realmTier*2; }
    function updateHUD(){
      els.realmChip.textContent = `Realm: ${tiers[state.realmTier]} ${state.realmLevel}`;
      els.qiChip.textContent = `Qi: ${Math.floor(state.qi)} / ${state.qiMax}`;
      els.hpChip.textContent = `HP: ${Math.floor(state.hp)} / ${state.hpMax}`;
      els.stonesChip.textContent = `Stones: ${state.stones}`;
      els.pillsChip.textContent = `Pills: ${state.pills}`;
      els.powerChip.textContent = `Power: ${state.power}`;
      // inventory counts
      els.invStones.textContent = state.stones;
      els.invPills.textContent = state.pills;
      const qiPct = Math.round((state.qi/state.qiMax)*100);
      const hpPct = Math.round((state.hp/state.hpMax)*100);
      els.qiFill.style.width = qiPct+'%'; els.qiLabel.textContent = `Qi ${qiPct}%`;
      els.hpFill.style.width = hpPct+'%'; els.hpLabel.textContent = `HP ${hpPct}%`;
      els.lvMeridian.textContent = state.skills.meridian;
      els.lvFist.textContent = state.skills.fist;
      els.lvBody.textContent = state.skills.body;
      els.lvFoot.textContent = state.skills.foot;
    }

    function msg(el, text){ el.textContent = text; }
    function log(text){ const div=document.createElement('div'); div.className='item'; div.textContent=text; els.logList.prepend(div); }

    // Cultivation actions
    els.meditateBtn.addEventListener('click',()=>{
      const gain = 6 + state.skills.meridian*2;
      state.qi = clamp(state.qi + gain, 0, state.qiMax);
      msg(els.statusCultivate,`Meditated: +${gain} Qi`);
      update();
    });
    function btCost(){
      const base = 50 + state.realmLevel*20 + state.realmTier*30;
      return Math.floor(base);
    }
    els.breakthroughBtn.addEventListener('click',()=>{
      const cost = btCost();
      if(state.qi<cost){ msg(els.statusCultivate,`Need ${cost} Qi.`); return; }
      state.qi-=cost;
      const pillBonus = Math.min(0.25, state.pills*0.05);
      const chance = 0.25 + state.realmTier*0.05 + state.skills.meridian*0.01 + pillBonus;
      if(Math.random()<chance){
        state.realmLevel++;
        if(state.realmLevel>9){ state.realmLevel=1; state.realmTier=Math.min(tiers.length-1, state.realmTier+1); }
        state.qi = Math.floor(state.qi*0.5);
        state.hpMax += 10; state.hp = state.hpMax;
        msg(els.statusCultivate,`Breakthrough! Advanced to ${tiers[state.realmTier]} ${state.realmLevel}.`);
        log(`Breakthrough succeeded.`);
      } else {
        state.hp = clamp(state.hp-10,0,state.hpMax);
        msg(els.statusCultivate,`Breakthrough failed. You feel drained.`);
        log('Breakthrough failed.');
      }
      update();
    });
    els.usePillBtn.addEventListener('click',()=>{
      if(state.pills<=0){ msg(els.statusCultivate,'No pills available.'); return; }
      state.pills -= 1; msg(els.statusCultivate,'Consumed a pill.'); update();
    });

    // Training
    function trainSkill(which){ if(state.stones<5){ log('Need 5 Spirit Stones.'); return; } state.stones-=5; state.skills[which]++; if(which==='body'){ state.hpMax+=6; state.hp=state.hpMax; } log(`Trained ${which}.`); update(); }
    els.trainMeridian.addEventListener('click',()=>trainSkill('meridian'));
    els.trainFist.addEventListener('click',()=>trainSkill('fist'));
    els.trainBody.addEventListener('click',()=>trainSkill('body'));
    els.trainFoot.addEventListener('click',()=>trainSkill('foot'));

    // Exploration
    els.exploreBtn.addEventListener('click',()=>{
      if(state.hp<=0){ msg(els.statusExplore,'You are too injured to explore. Rest or breakthrough first.'); return; }
      const r = Math.random();
      if(r<0.4){
        const found = 5 + Math.floor(Math.random()*6);
        state.stones += found;
        const t = `Found ${found} Spirit Stones.`;
        log(t); msg(els.statusExplore, t);
      } else if(r<0.55){
        state.pills += 1; log('Found a pill!'); msg(els.statusExplore,'Found a pill!');
      } else if(r<0.85){
        msg(els.statusExplore,'Encountered an enemy!');
        startCombat();
      } else {
        const heal = 5 + Math.floor(Math.random()*6);
        state.hp = Math.min(state.hpMax, state.hp + heal);
        const t = `Rested at a serene spring (+${heal} HP).`;
        log(t); msg(els.statusExplore, t);
      }
      update();
    });

    // Combat system
    function startCombat(){
      if(state.hp<=0){ msg(els.statusExplore,'You are too injured to fight.'); return; }
      const enemy = genEnemy();
      state.combat = { enemy, defend:false };
      // exploration leads to combat; ensure explore is the active tab after combat ends
      currentPanelId = 'panel-explore';
      showCombat(true);
      // reset combat status text and HUD before first action
      msg(els.statusCombat,'');
      updateCombatHUD();
      msg(els.statusCombat,`Encountered ${enemy.name}!`);
    }
    function genEnemy(){
      const scale = 1 + state.realmTier*0.8 + state.realmLevel*0.2;
      const hp = Math.floor(60*scale + state.skills.body*5);
      const pow = Math.floor(6*scale + state.realmTier*2);
      const names = ['Bandit','Wild Beast','Rogue Cultivator','Forest Spider'];
      return {name:names[Math.floor(Math.random()*names.length)], hp, hpMax:hp, power:pow};
    }
    function showCombat(v){
      els.panelCombat.style.display = v? 'block':'none';
      if(v){
        // hide other panels to focus on combat
        [els.panelCultivate,els.panelTrain,els.panelExplore,els.panelInventory].forEach(p=>p.hidden=true);
      } else {
        // show only the previously active (non-combat) panel
        [els.panelCultivate,els.panelTrain,els.panelExplore,els.panelInventory].forEach(p=>p.hidden=true);
        document.getElementById(currentPanelId).hidden=false;
      }
    }
    function updateCombatHUD(){
      const e = state.combat.enemy;
      els.youHP.textContent = Math.floor(state.hp);
      els.youHPMax.textContent = Math.floor(state.hpMax);
      els.youPow.textContent = state.power;
      els.enHP.textContent = Math.floor(e.hp);
      els.enHPMax.textContent = Math.floor(e.hpMax);
      els.enPow.textContent = e.power;
    }
    function playerAttack(mult=1){
      const dodge = 0.03*state.skills.foot;
      const dmg = Math.floor((state.power + Math.random()*state.skills.fist)*mult);
      state.combat.enemy.hp = Math.max(0, state.combat.enemy.hp - dmg);
      msg(els.statusCombat,`You hit ${state.combat.enemy.name} for ${dmg}.`);
      if(state.combat.enemy.hp<=0){
        const reward = 8 + Math.floor(Math.random()*8);
        state.stones += reward;
        log(`Victory! Looted ${reward} Spirit Stones.`);
        // end combat and return to previously active tab
        state.combat=null; showCombat(false); update(); return;
      }
      // enemy turn
      const evaded = Math.random()<dodge;
      if(evaded){ msg(els.statusCombat,`You evaded the attack!`); updateCombatHUD(); return; }
      const eDmg = Math.floor(state.combat.enemy.power + Math.random()*4) - (state.combat.defend? 5:0);
      state.combat.defend = false;
      state.hp = Math.max(0, state.hp - Math.max(1,eDmg));
      if(state.hp<=0){ msg(els.statusCombat,'You were defeated...'); state.combat=null; showCombat(false); update(); return; }
      updateCombatHUD();
    }
    els.actAttack.addEventListener('click',()=>playerAttack(1));
    els.actDefend.addEventListener('click',()=>{ state.combat.defend=true; msg(els.statusCombat,'You brace yourself.'); playerAttack(0); });
    els.actSkill.addEventListener('click',()=>{
      if(state.qi<10){ msg(els.statusCombat,'Not enough Qi.'); return; }
      state.qi-=10; playerAttack(1.6);
      update();
    });
    els.actFlee.addEventListener('click',()=>{
      if(Math.random()<0.65){ msg(els.statusCombat,'You fled successfully.'); showCombat(false); state.combat=null; }
      else { msg(els.statusCombat,'Failed to flee.'); playerAttack(0); }
      update();
    });

    // Helpers
    function btCost(){
      const base = 50 + state.realmLevel*20 + state.realmTier*30;
      return Math.floor(base);
    }
    function msg(el, text){ el.textContent = text; }
    function log(text){ const div=document.createElement('div'); div.className='item'; div.textContent=text; els.log.prepend(div); }

    function update(){
      recalc(); updateHUD(); updateButtons(); updateCombatHUDIf();
    }
    function updateButtons(){
      els.breakthroughBtn.disabled = state.qi < btCost();
      [els.trainMeridian,els.trainFist,els.trainBody,els.trainFoot].forEach(b=>b.disabled = state.stones<5);
      els.usePillBtn.disabled = state.pills<=0;
    }
    function updateCombatHUDIf(){ if(state.combat) updateCombatHUD(); }

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.target && (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')) return;
      const k=e.key;
      if(k==='1') selectTab('tab-cultivate','panel-cultivate');
      if(k==='2') selectTab('tab-train','panel-train');
      if(k==='3') selectTab('tab-explore','panel-explore');
      if(k==='4') selectTab('tab-inventory','panel-inventory');
      if(k==='m' || k==='M') els.meditateBtn.click();
      if(k==='b' || k==='B') els.breakthroughBtn.click();
      if(k==='e' || k==='E') els.exploreBtn.click();
    });

    // Init
    recalc(); update();
    log('Welcome. Seek Dao through diligence.');
  })();
  </script>
</body>
</html>
